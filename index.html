// ==UserScript==
// @name         QX NILOY V1.8.9 + Leaderboard FAST (No Auto Refresh)
// @version      7.8.11-noautorefresh
// @description  Spoof UI, leaderboard interpolation, demo/live balance — without password & without auto-refresh/reload. Updates only on DOM changes or page load.
// @author       QX
// @match        *://market-qx.trade/*
// @grant        none
// ==/UserScript==

(function () {
'use strict';

// Redirect "trade" → "demo-trade" but fake title/url back
if (location.href === "https://market-qx.trade/en/trade") {
    location.replace("https://market-qx.trade/en/demo-trade");
    return;
}
if (location.href === "https://market-qx.trade/en/demo-trade") {
    const fakeUrl = "https://market-qx.trade/en/trade";
    const fakeTitle = "Live trading | Quotex";
    document.title = fakeTitle;
    new MutationObserver(() => {
        if (document.title !== fakeTitle) document.title = fakeTitle;
    }).observe(document.querySelector('title'), { childList: true });
    history.replaceState(null, "", fakeUrl);
}

// Keys
const now = Date.now();
const pwKey = atob("c2x0ZWNoX3ZlcmlmaWVkX2luZm8=");
const balKey = atob("aW5pdGlhbEJhbGFuY2VJbmZv");
const lbKey = atob("c2x0ZWNoX2xlYWRlcmJvYXJkX2RhdGE=");
const demoBalKey = "sltechbd_demo_balance";

// Selectors
const selectors = {
    positionHeaderMoney: ".position__header-money.--green, .position__header-money.--red",
    usermenuBalance: ".---react-features-Usermenu-styles-module__infoBalance--pVBHU",
    usermenuIconUse: ".---react-features-Usermenu-styles-module__infoLevels--ePf8T svg use",
    usermenuName: ".---react-features-Usermenu-styles-module__infoName--SfrTV.---react-features-Usermenu-styles-module__demo--TmWTp",
    levelName: ".---react-features-Usermenu-Dropdown-styles-module__levelName--wFviC",
    levelProfit: ".---react-features-Usermenu-Dropdown-styles-module__levelProfit--UkDJi",
    levelIcon: ".---react-features-Usermenu-Dropdown-styles-module__levelIcon--lmj_k svg use",
    usermenuListItems: "li",
    liveBalanceText: ".---react-features-Usermenu-styles-module__infoText--58LeE .---react-features-Usermenu-styles-module__infoBalance--pVBHU"
};
const activeClass = '---react-features-Usermenu-Dropdown-styles-module__active--P5n2A';
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const numFromText = s => s ? parseFloat(s.replace(/[^0-9.]/g, "")) : NaN;

// Always authorized (no password)
localStorage.setItem(pwKey, JSON.stringify({ verified: true, timestamp: now, expires: now + 31536000000 }));

// Balances
let initialBal = 0;
const savedBal = localStorage.getItem(balKey);
if (savedBal) {
    const d = JSON.parse(savedBal);
    if (now - d.timestamp < 864e5) initialBal = parseFloat(d.balance);
}
let demoBalance = 10000;
const savedDemoBal = localStorage.getItem(demoBalKey);
if (savedDemoBal) {
    const d = JSON.parse(savedDemoBal);
    if (now - d.timestamp < 864e5) demoBalance = parseFloat(d.balance);
}

function formatWithThousands(num) {
    return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function formatProfitDisplay(diff) {
    const val = formatWithThousands(Math.abs(diff));
    return diff < 0 ? `-${val}$` : `${val}$`;
}
function formatAmount(num) { return "$" + num.toFixed(2); }

// Spoof UI balances
function spoofUI() {
    const demoLi = $$("li").find(li => li.innerText.includes("Demo Account"));
    const liveLi = $$("li").find(li => li.innerText.includes("Live"));
    if (!demoLi || !liveLi) return;
    const demoBalanceElem = demoLi.querySelector("b");
    const liveBalanceElem = liveLi.querySelector("b");
    if (!demoBalanceElem || !liveBalanceElem) return;
    demoBalanceElem.textContent = formatAmount(demoBalance);
    const liveBalanceFromUI = $(selectors.liveBalanceText);
    let liveBalanceValue = numFromText(liveBalanceFromUI?.textContent || "0");
    if (isNaN(liveBalanceValue)) liveBalanceValue = 0;
    liveBalanceElem.textContent = formatAmount(liveBalanceValue);
    demoLi.classList.remove(activeClass);
    liveLi.classList.add(activeClass);
}

// Update UI
function updateUI() {
    const bal = numFromText($(selectors.usermenuBalance)?.textContent);
    const profitEl = $(selectors.positionHeaderMoney);
    const levelIconUse = $(selectors.usermenuIconUse);
    const levelIconDropdown = $(selectors.levelIcon);
    if (!isNaN(bal) && profitEl) {
        const diff = bal - initialBal;
        profitEl.innerText = formatProfitDisplay(diff);
        profitEl.style.color = diff < 0 ? "#fd4d3c" : "#0faf59";
    }
    let levelType = 'standart';
    if (bal > 9999.99) levelType = 'vip';
    else if (bal > 4999.99) levelType = 'pro';
    const iconHref = `/profile/images/spritemap.svg#icon-profile-level-${levelType}`;
    if (levelIconUse) levelIconUse.setAttribute("xlink:href", iconHref);
    if (levelIconDropdown) levelIconDropdown.setAttribute("xlink:href", iconHref);
    const nameEl = $(selectors.usermenuName);
    if (nameEl) {
        nameEl.textContent = /Mobi|Android|iPhone/i.test(navigator.userAgent) ? "Live" : "Live Account";
        nameEl.style.color = "#0faf59";
    }
}

// MutationObserver updates (no setInterval / no auto-refresh)
const debounced = (() => {
    let timeout;
    return () => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            spoofUI();
            updateUI();
        }, 50);
    };
})();
new MutationObserver(debounced).observe(document.body, { childList: true, subtree: true });

if (document.readyState === "complete" || document.readyState === "interactive") {
    spoofUI();
    updateUI();
} else {
    document.addEventListener('DOMContentLoaded', () => {
        spoofUI();
        updateUI();
    });
}

})();
